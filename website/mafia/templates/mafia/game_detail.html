{% extends "mafia/base.html" %}


{% block head_title %} {{ game.name }} ({{ game.variant }}) {% endblock %}


{% block head_extras %}
  <link href="{{ STATIC_URL }}mafia/css/mafia.css" rel="stylesheet" type="text/css"/>
{% endblock %}


{% block header %}
  <h1>{{ game.name }} ({{ game.variant }})</h1>
{% endblock %}


{% block content %}

  <div>

    <ul class="nav nav-tabs">
      <li class="active"><a href="#game" data-toggle="tab">Game</a></li>
      <li><a href="#logs" data-toggle="tab">Logs</a></li>
    </ul>

    <div class="tab-content">

      <div id="game" class="tab-pane fade in active">

        <section id="game-over" style="display: none;">
          <div class="alert alert-warning">
            <span class="glyphicon glyphicon-info-sign"></span> Game is over.
          </div>
        </section>

        <!-- Game Action Form ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        {% if game.is_ongoing %}

          <form id="game-action-form" class="form-inline" action="{% url mafia-game-play pk=game.pk %}" method="post" onsubmit="return executeAction();">

            <div class="row">
              <div class="col-md-9">
                <h2 id="game-round">Round ?</h2>
                <div>
                  <p>Select one or more targets below...</p>
                  <div class="form-group">
                    <input class="form-control" type="text" name="magic" placeholder="Magic: Black / White"/>
                  </div>
                  <div class="form-group">
                    <button class="btn btn-primary" type="submit">Execute <span id="game-action">Action</span></button>
                    <span class="done text-success glyphicon glyphicon-ok-sign" style="display: none;"></span>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="well" style="text-align: center;">
                  <div id="game-timer" class="game-timer">--</div>
                  <div>
                    <a class="btn btn-sm btn-default" href="javascript:void(0);" onclick="return refresh();">
                      <span class="glyphicon glyphicon-refresh"></span> Refresh
                    </a>
                    <a id="start-heartbeat-button" class="btn btn-sm btn-primary" style="display: none;" href="javascript:void(0);" onclick="return startHeartbeat();">
                      <span class="glyphicon glyphicon-play"></span> Start
                    </a>
                    <a id="pause-heartbeat-button" class="btn btn-sm btn-danger" style="display: none;" href="javascript:void(0);" onclick="return pauseHeartbeat();">
                      <span class="glyphicon glyphicon-pause"></span> Pause
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              {% for player in game.player_set.all %}
                <div class="col-md-3">
                  <div id="player-{{ player.pk }}" class="player">
                    <div class="player-heading">
                      <img class="img-circle" src="{{ player.gravatar_url }}" alt="{{ player }}"/>
                      <h4>{{ player }}</h4>
                      <div class="clearfix"></div>
                    </div>
                    <div class="player-body">
                      <div class="player-role">
                        <a href="javascript:void(0);" onclick="return togglePlayerCheckbox({{ player.pk }});">
                          <img class="img-thumbnail" src="http://placehold.it/60x60" alt="{{ player.role }}"/>
                        </a>
                        <span class="player-disabled glyphicon glyphicon-remove-sign" style="display: none;"></span>
                        <span class="player-checked glyphicon glyphicon-ok-sign" style="display: none;"></span>
                        {% if request.user == player.user %}
                          <span class="label label-success">YOU</span>
                        {% endif %}
                      </div>
                      <div class="player-details">
                        <div><span class="role label label-primary"></span></div>
                        <div class="tags"></div>
                      </div>
                      <div class="clearfix"></div>
                    </div>
                    <div style="display: none;">
                      <input type="checkbox" name="target_pk[]" value="{{ player.pk }}"/>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>

          </form>

        {% endif %}

        <form class="form-inline" action="{% url mafia-game-start pk=game.pk %}" method="post">
          {% csrf_token %}
          <div class="alert alert-danger">
            <div class="form-group"><button class="btn btn-danger" type="submit">(Re)Start the game!</button></div>
          </div>
        </form>

      </div>

      <div id="logs" class="tab-pane fade">
        <ul class="list-unstyled">
          {% for log in game.log_set.all %}
            <li><code>{{ log }}</code></li>
          {% endfor %}
        </ul>
      </div>

    </div>

  </div>

{% endblock %}


{% block bottom_extras %}

  <script type="text/javascript">//<![CDATA[

    /// Timestamp of the last update, used to decide if we need to refresh players.
    var updateTimestamp = null;

    /// Game heartbeat ID returned by setInterval(), used in clearInterval().
    var heartbeatId = null;

    function uncheckPlayers() {
      $('.player').each(function() {
        $('input[name="target_pk[]"]', this).prop('checked', false);
        $('.player-checked', this).hide();
      });
    }

    function togglePlayerCheckbox(playerPK) {
      var element = $('#player-' + playerPK);
      if (element.hasClass('player-checkable')) {
        var checkbox = $('input[name="target_pk[]"]', element);
        var isChecked = !checkbox.prop('checked');
        checkbox.prop('checked', isChecked);
        $('.player-checked', element).toggle(isChecked);
      } else {
        $('.player-disabled', element).show().delay(200).fadeOut();
      }
      return false;
    }

    function updateGameState(game) {
        $('#game-over').toggle(game.is_over);
        $('#game-round').text('Round ' + game.round);
        if (game.current_action != null) {
          $('#game-action').text(game.current_action.name);
        }
    }

    function updatePlayer(player, isSelectable) {
      var element = $('#player-' + player.pk);
      // Update player information...
      $('.role', element).text(player.role);
      element.toggleClass('player-out', player.is_out);
      element.toggleClass('player-checkable', isSelectable);
      // Update player tags...
      var tagsElement = $('.tags', element).empty();
      for (var j = 0; j < player.tags.length; j++) {
        $('<span class="label label-default"></span>').text(player.tags[j]).appendTo(tagsElement);
      }
    }

    function refresh() {
      heartbeat();
      return false;
    }

    function heartbeat() {
      $.ajax({
        url: '{% url mafia-game-heartbeat pk=game.pk %}',
        type: 'get'
      }).done(function(game) {
        $('#game-timer').removeClass('text-danger').addClass('text-success').text(game.elapsed_seconds_since_last_update);
        if (game.update_date != updateTimestamp) {
          updateTimestamp = game.update_date;
          updateGameState(game);
          for (var i = 0; i < game.players.length; i++) {
            var player = game.players[i];
            var isSelectable = (game.possible_target_pk_list.indexOf(player.pk) != -1);
            updatePlayer(player, isSelectable);
          }
        }
        if (game.is_over) {
          pauseHeartbeat();
        }
      }).fail(function() {
        $('#game-timer').removeClass('text-success').addClass('text-danger').text('ERR');
      });
    }

    function startHeartbeat() {
      $('#start-heartbeat-button').hide();
      $('#pause-heartbeat-button').show();
      updateTimestamp = null;
      heartbeatId = setInterval(heartbeat, 2000);
      return false;
    }

    function pauseHeartbeat() {
      $('#pause-heartbeat-button').hide();
      $('#start-heartbeat-button').show();
      if (heartbeatId != null) {
        clearInterval(heartbeatId);
      }
      heartbeatId = null;
      return false;
    }

    function executeAction() {
      var form = $('#game-action-form');
      $('.done', form).hide();
      $.ajax({
        url: form.attr('action'),
        type: form.attr('method'),
        data: form.serialize()
      }).done(function(data) {
        $('.done', form).show().delay(200).fadeOut();
        uncheckPlayers();
      }).fail(function(data) {
        alert('failed:');
        $('.done', form).hide();
      }).always(function() {
        refresh();
      });
      return false;
    }

    {% if game.is_ongoing %}
      $(function() {
        pauseHeartbeat();
        refresh();
      });
    {% endif %}

  //]]></script>

{% endblock %}

